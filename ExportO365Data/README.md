# ExportO365Data
This script takes and XML file generated by my other MicrosoftFormsLeaver script and exports the users mailbox from O365 using the data inside the XML file. <br /> In detail, the script will connect to the O365 Compliance shell, create a new Content Search, create an Export, and then download the generated .PST file using the UnifiedExportTool.  
The script can work without Forms/Flow/MicrosoftFormsLeaver, you'll just need to generate the XML file yourself somehow.

### Prerequisites/things to note
- This script is inspired and very much based off of [this techcommunity thread](https://techcommunity.microsoft.com/t5/Office-365/Export-to-PST-via-Powershell/m-p/95007) that I found while researching and trying to find a way to do this.
- You'll need to get hold of a copy of the UnifiedExportTool from the MS site (explained further down the script).
- In our production environment, this script runs on the same server as our Azure AD Connect agent, and the rest of the other O365 automation scripts.

##### Getting the UnifiedExportTool
- Login to the [Security & Compliance Center](https://protection.office.com/?rfr=AdminCenter#/permissions) using **Internet Explorer**. Head over to **Search & Investigation** and then open up **Content search**.
- Inside the **Searches** tab, create a new search, and save & run as usual.
- Once the search has completed, go back to the **Searches** list view and open it up. Click the dropdown under **More** and hit **Export results**. Leave everything as default and hit **Export**.
- Head to the **Exports** tab and open the export you just started. Along the top, hit **Download results** button. The eDiscovery Export Tool should open up.


- Once the tool is opened up, open **Task Manager**, find the Export Tool, **right-click** it and **Open file location**.
- Explorer should open up and give you the file, for me the file path for it was as follows: `%localappdata%\Apps\2.0\L3VXP29X.E5R\AN2WMLWZ.L94\micr..tool_a8eee8aa09b0c4a7_000f.0014_b35952983255bd05`
- From this point, you can copy everything inside the folder to a new location accessible to the service account the script runs as, and also change the variable ```$UnifiedExportTool``` to match the new location.



### How to use
In our environment, the setup for this script is as follows:
- Generic O365 "service" account that is an "eDiscovery Manager" inside the Security & Compliance Center on O365.
- Scripts run from the same server as the Azure AD Connect agent and other O365 automation scripts (useful but not necessary).
- Generic AD "service" account that can be used to run the script (from inside Task Scheduler) and also authenticated against/have permission to the RemoteExportLocation top level folder. (**\\\LON-FILE01\LeaverProfiles\** for example).

To get things started, you'll want to grant the **eDiscovery Manager** permission to the generic O365 service account by going into the [Security & Compliance Center](https://protection.office.com/?rfr=AdminCenter#/permissions), like so:   
<img src="/Images/ExportO365Data/SecurityAndCompliancePermissions.png" width="90%">

Once you the account has permissions, you'll want to grant your AD "service" account read/write permissions to the network share where your leavers data is going to go.    

After doing this, the next thing to do is put the script somewhere it can run without interruptions (the server AADConnect is running is a good place), and read/edit the top section of the script with usernames/passwords/filepaths. (There's also some useful comments in there related to event logging)   

I've included an example of the XML file the MicrosoftFormsLeaver script generates, a vbs file to launch the script from (without it popping up a blank PowerShell window every time), and a scheduled task XML file that you should be able to edit with the filepath/username and then import into Task Scheduler.    
In our case, we have a scheduled task running every day at 7PM as the Generic AD Service account (the MicrosoftFormsLeaver script runs at 6PM so should be plenty of time for it to finish).

## Other useful info
- Every time I update the script in our production environment I'll try to update this repo
- I've probably missed some bits off of this readme, but if I do notice anything I'll add it to this
- This script directly works with the [MicrosoftFormsLeaver](https://github.com/danjunx/O365-Scripts/tree/master/MicrosoftFormsLeaver) script using the same XML reading stuff to "nuke" a leavers account, so it's definitely worth checking that one out too.
